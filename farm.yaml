---
- job:
      name: 'Farm-UpdateEnv'
      node: node.priority.normal
      concurrent: false
      wrappers:
          - timestamps
          - ansicolor
          - timeout:
                timeout: 40
                fail: true
                type: no-activity
          - credentials-binding:
                - username-password-separated:
                      credential-id: azure-jenkinsapp-SA
                      username: ARM_CLIENT_ID
                      password: ARM_CLIENT_SECRET
                - text:
                      credential-id: azure-jenkinsapp-terraformstorage
                      variable: ARM_ACCESS_KEY
      triggers:
          - reverse:
                jobs: 'TestBench-Host-BuildFlatcar'
          - gerrit:
                trigger-on:
                    - change-merged-event
                projects:
                    - project-compare-type: 'PLAIN'
                      project-pattern: 'swi-farm'
                      branches:
                          - branch-compare-type: 'PLAIN'
                            branch-pattern: 'master'
                server-name: 'gerrit-legato'
      parameters:
          - string:
                name: VERSION
                default: ''
                description: 'Flatcar version to use (latest if empty)'
          - string:
                name: CONFIG_URL
                default: 'https://swifarmusw2.blob.core.windows.net/config/rdDeaXh9X2kWGcGc'
                description: 'Boot server IP'
      properties:
          - inject:
                properties-content: |
                    CHECKOUT_PROJECT=swi-farm
                    SSH_USER=CARMD-EV-LXCIM_sa
                    DOCKER_ENCAPS_SHELL=/bin/bash
                    DOCKER_ENCAPS_IMG=registry.legato/os-farm-toolbox-18.04
                    DOCKER_ENCAPS_ARGS=--volumes-from=legato-jenkins \
                                       --volume=$WORKSPACE/passwd:/etc/passwd \
                                       --volume=$WORKSPACE/group:/etc/group \
                                       --volume=$WORKSPACE:$HOME \
                                       --volume=$WORKSPACE:/ws \
                                       --env WORKSPACE=/ws \
                                       --volume=/storage/artifacts/flatcar:/storage/artifacts/flatcar \
                                       --volume=/storage/artifacts/farm:/storage/artifacts/farm \
                                       --volume=/storage/flatcar:/storage/flatcar \
                                       --volume=/storage/git:/storage/git:ro \
                                       --env LEGATO_SCRIPT_PATH=/legato-jenkins \
                                       --env CONFIG_URL \
                                       --env-file /etc/environment \
                                       --env-file /etc/farm-environment \
                                       --env NODE_LABELS \
                                       --env BUILD_CAUSE \
                                       --env VERSION \
                                       --env ARM_CLIENT_ID \
                                       --env ARM_CLIENT_SECRET \
                                       --env ARM_ACCESS_KEY
      builders:
          - cleanup-workspace
          - checkout-project
          - provide-local-user
          - provide-jenkins-creds
          - shell: !include-raw: farm-update.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace
          - slack:
                notify-start: false
                notify-success: false
                notify-aborted: false
                notify-not-built: false
                notify-unstable: true
                notify-failure: true
                notify-back-to-normal: true
                notify-repeated-failure: true

- job:
      name: 'Farm-Config-Review'
      node: node.priority.normal
      triggers:
          - gerrit:
                trigger-on:
                    - patchset-created-event:
                          exclude-no-code-change: true
                projects:
                    - project-compare-type: 'PLAIN'
                      project-pattern: 'swi-farm'
                      branches:
                          - branch-compare-type: 'PLAIN'
                            branch-pattern: 'master'
                server-name: 'gerrit-legato'
      properties:
          - inject:
                properties-content: |
                    CHECKOUT_PROJECT=swi-farm
                    DOCKER_ENCAPS_SHELL=/bin/bash
                    DOCKER_ENCAPS_IMG=registry.legato/os-farm-toolbox-20.10
                    DOCKER_ENCAPS_ARGS=--volumes-from=legato-jenkins \
                                       --volume=$WORKSPACE/passwd:/etc/passwd \
                                       --volume=$WORKSPACE/group:/etc/group \
                                       --volume=$WORKSPACE/.ssh:$HOME/.ssh \
                                       --volume=/usr/bin:/host_bin \
                                       --env LEGATO_SCRIPT_PATH=/legato-jenkins \
                                       --env UPDATE_USER=jenkins-scp \
                                       --env JENKINS_WORKSPACE=$WORKSPACE \
                                       --env-file /etc/environment \
                                       --env VERSION=$VERSION
      builders:
          - cleanup-workspace
          - checkout-project
          - provide-local-user
          - shell: !include-raw: farm-configcheck.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace

- job:
      name: 'Farm-Control-Updated'
      concurrent: false
      project-type: pipeline
      triggers:
          - gerrit:
                trigger-on:
                    - ref-updated-event
                projects:
                    - project-compare-type: 'PLAIN'
                      project-pattern: 'farm-control'
                      branches:
                          - branch-compare-type: 'PLAIN'
                            branch-pattern: 'master'
                          - branch-compare-type: 'ANT'
                            branch-pattern: 'refs/tags/*'
                server-name: 'gerrit-legato'
      dsl: !include-raw: farm-control.groovy

- job:
      name: 'Farm-Control-Review'
      project-type: pipeline
      triggers:
          - gerrit:
                trigger-on:
                    - patchset-created-event
                projects:
                    - project-compare-type: 'PLAIN'
                      project-pattern: 'farm-control'
                      branches:
                          - branch-compare-type: 'PLAIN'
                            branch-pattern: 'master'
                server-name: 'gerrit-legato'
      dsl: !include-raw: farm-control.groovy

- job:
      name: 'Farm-Control-Build'
      wrappers:
          - timestamps
          - ansicolor
          - timeout:
                timeout: 40
                fail: true
                type: no-activity
          - credentials-binding:
                - file:
                      credential-id: k8s-kubeconfig
                      variable: KUBECONFIG
                - username-password-separated:
                      credential-id: azure-cr-swifarm
                      username: AZCR_USERNAME
                      password: AZCR_PASSWORD
      parameters:
          - bool:
                name: DEPLOY
                default: false
                description: 'Deploy in production'
      properties:
          - inject:
                properties-content: |
                    CHECKOUT_PROJECT=farm-control
                    SSH_USER=CARMD-EV-LXCIM_sa
                    DOCKER_ENCAPS_SHELL=/bin/bash
                    DOCKER_ENCAPS_IMG=registry.legato/os-farm-toolbox-18.04
      builders:
          - cleanup-workspace
          - checkout-project
          - provide-local-user
          - provide-jenkins-creds
          - shell: !include-raw: farm-controldeploy.sh
          - inject:
                properties-file: build_env
          - shell: !include-raw: farm-controlk8s.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace

- job:
      name: 'Farm-GenerateCIGraph'
      node: production && (node.priority.normal || master)
      concurrent: false
      wrappers:
          - timestamps
          - ansicolor
          - timeout:
                timeout: 120
                fail: true
                type: no-activity
      parameters:
          - string:
                name: FROM
                default: ''
                description: 'Specific date .e.g 2018-06-04'
          - string:
                name: TO
                default: ''
                description: 'Specific date .e.g 2018-06-10'
      properties:
          - build-discarder:
                days-to-keep: 31
          - inject:
                properties-content: |
                    DOCKER_ENCAPS_SHELL=/bin/bash
                    DOCKER_ENCAPS_NET=--hostname=jenkins
                    DOCKER_ENCAPS_IMG=registry.legato/os-farm-toolbox-18.04
                    DOCKER_ENCAPS_ARGS=--volume=$WORKSPACE/passwd:/etc/passwd \
                                       --volume=$WORKSPACE/group:/etc/group \
                                       --volume=$WORKSPACE/.ssh:$HOME/.ssh \
                                       --volume=/sys/fs/selinux:/sys/fs/selinux:ro \
                                       --volume=/storage/artifacts/farm/graph:/storage/artifacts/farm/graph \
                                       --volumes-from=legato-jenkins \
                                       --volume=$WORKSPACE/.pip3:$HOME/.pip3 \
                                       --volume=$WORKSPACE/.local:$HOME/.local \
                                       --volume=$WORKSPACE/.cache:$HOME/.cache \
                                       --volume=/etc/environment:/etc/host-environment:ro \
                                       --volume=/etc/farm-environment:/etc/farm-environment:ro \
                                       --env-file=$WORKSPACE/user_env \
                                       --env JENKINS_HOME=$JENKINS_HOME \
                                       --env LEGATO_SCRIPT_PATH=/legato-jenkins \
                                       --env BUILD_NUMBER=$BUILD_NUMBER \
                                       --env-file=$WORKSPACE/params
      triggers:
          - timed: '0 * * * *'
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-build-user
          - shell: |
                mkdir -p "/storage/artifacts/farm/graph"
                mkdir -p .local
                mkdir -p .pip3
                mkdir -p .cache
                echo "FROM=$FROM" >> params
                echo "TO=$TO" >> params
          - shell: !include-raw: farm-generatecigraph.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace

- job_common_node: &job_common_node
      name: 'job_common_node'
      node: master
      wrappers:
          - timestamps
          - ansicolor
          - timeout:
                timeout: 40
                fail: true
                type: no-activity
          - credentials-binding:
                - file:
                      credential-id: k8s-kubeconfig
                      variable: KUBECONFIG
      properties:
          - build-discarder:
                days-to-keep: 30
          - inject:
                properties-content: |
                    SSH_USER=CARMD-EV-LXCIM_sa
                    DOCKER_ENCAPS_SHELL=/bin/bash
                    DOCKER_ENCAPS_IMG=registry.legato/os-farm-toolbox-18.04
                    DOCKER_ENCAPS_NET=--hostname=jenkins
                    CHECKOUT_PROJECT=swi-farm
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-jenkins-creds
          - checkout-project
          - shell: !include-raw: farm-commonenv.sh
          - inject:
                properties-file: build_env
          - description-setter:
                regexp: '^Scope: (.*)'
          - shell: !include-raw: farm-common.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace
          - slack:
                notify-start: false
                notify-success: false
                notify-aborted: false
                notify-not-built: false
                notify-unstable: true
                notify-failure: true
                notify-back-to-normal: true
                notify-repeated-failure: true

- job:
      <<: *job_common_node
      name: 'Farm-RestartNodes'
      concurrent: false
      parameters:
          - bool:
                name: FORCE
                default: false
                description: 'Force the reboot of nodes even if the load is high'

- job:
      name: 'Farm-JobPendingCleanup'
      project-type: pipeline
      concurrent: false
      properties:
          - build-discarder:
                days-to-keep: 15
      triggers:
          - timed: '0 * * * *'
      dsl: !include-raw: 'farm-jobcleanup.groovy'

- job:
      name: 'Farm-Scale'
      node: master
      concurrent: false
      wrappers:
          - timestamps
          - ansicolor
          - timeout:
                timeout: 60
                fail: true
                type: no-activity
          - credentials-binding:
                - username-password-separated:
                      credential-id: azure-jenkinsapp-SA
                      username: ARM_CLIENT_ID
                      password: ARM_CLIENT_SECRET
                - text:
                      credential-id: azure-jenkinsapp-terraformstorage
                      variable: ARM_ACCESS_KEY
      triggers:
          - timed: '*/4 * * * *'
      parameters:
          - string:
                name: TARGET_NB_NODES
                default: ''
                description: '(optional) Number of nodes to instanciate'
          - bool:
                name: PARALLELIZE
                default: true
                description: '(optional) Parallelize node updates'
      properties:
          - build-discarder:
                days-to-keep: 7
          - inject:
                properties-content: |
                    SSH_USER=CARMD-EV-LXCIM_sa
                    DOCKER_ENCAPS_SHELL=/bin/bash
                    DOCKER_ENCAPS_IMG=registry.legato/os-farm-toolbox-18.04
                    DOCKER_ENCAPS_NET=--hostname=jenkins
                    CHECKOUT_PROJECT=swi-farm
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-jenkins-creds
          - checkout-project
          - enable-sudo
          - system-groovy:
                command: !include-raw: farm-collectmetrics.groovy
          - shell: !include-raw: farm-commonenv.sh
          - inject:
                properties-file: build_env
          - shell: !include-raw: farm-common.sh
          - system-groovy:
                command: !include-raw: farm-scale.groovy
      publishers:
          - groovy-postbuild:
                script: !include-raw: farm-scalepub.groovy
          - encaps-cleanup
          - cleanup-workspace
          - slack:
                notify-start: false
                notify-success: false
                notify-aborted: false
                notify-not-built: false
                notify-unstable: false
                notify-failure: true
                notify-back-to-normal: true
                notify-repeated-failure: true

- job:
      name: 'Farm-Host-BuildTorcxZfs'
      node: production && node.priority.normal
      wrappers:
          - timestamps
          - ansicolor
          - timeout:
                timeout: 60
                fail: true
                type: no-activity
          - credentials-binding:
                - username-password-separated:
                      credential-id: acr-account
                      username: ACR_USERNAME
                      password: ACR_PASSWORD
      triggers:
          - pollurl:
                cron: '@hourly'
                urls:
                    - url: 'https://www.flatcar-linux.org/releases-json/releases-stable.json'
                      check-content:
                          - simple: true
      parameters:
          - string:
                name: ZOL_VERSION
                description: 'Zfs on Linux version'
          - string:
                name: FLATCAR_VERSION
                description: ''
          - string:
                name: FLATCAR_CHANNEL
                description: ''
          - bool:
                name: FORCE
                default: false
      properties:
          - heavy-job:
                weight: 3
          - inject:
                properties-content: |
                    DOCKER_ENCAPS_WEIGHT=3
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-jenkins-creds
          - enable-sudo
          - shell: !include-raw: farm-host-buildtorcxzfsenv.sh
          - inject:
                properties-file: build_env
          - description-setter:
                regexp: '^Version: (.*)'
          - shell: !include-raw: farm-host-buildtorcxzfs.sh
          - inject:
                properties-file: build_env_2
          - shell: |
                #!/usr/bin/encaps

                source $LEGATO_SCRIPT_PATH/common.sh

                check_ssh github.com
                check_ret

                set -xe

                cd "$WORKSPACE/torcx-zfs-bin"

                TAG_NAME="${ZOL_VERSION}-${FLATCAR_VERSION}-flatcar"

                set_git_user
                git add .
                git commit -m "ZoL ${ZOL_VERSION} for Flatcar ${FLATCAR_CHANNEL}:${FLATCAR_VERSION}"
                git tag "${TAG_NAME}"

                FORCE_ARG=""
                if [[ "$FORCE" == "true" ]]; then
                    FORCE_ARG="--force"
                elif [ $(git ls-remote origin "refs/tags/${TAG_NAME}" | wc -l) -eq 1 ]; then
                    message $COLOR_INFO "Tag already present and not forcing"
                    exit 0
                fi
                git push ${FORCE_ARG} origin "refs/tags/${TAG_NAME}":"refs/tags/${TAG_NAME}"

      publishers:
          - encaps-cleanup
          - cleanup-workspace
          - slack:
                notify-start: true
                notify-success: false
                notify-aborted: false
                notify-not-built: false
                notify-unstable: false
                notify-failure: true
                notify-back-to-normal: true
                notify-repeated-failure: true

- job:
      <<: *job_common_node
      name: 'Farm-RestartNode'
      parameters:
          - string:
                name: NODE_IP
                default: ''
                description: 'IP of the node to reboot'
          - string:
                name: NODE_NAME
                default: ''
                description: '(optional) Node name, for debug purpose'
          - bool:
                name: FORCE
                default: false
                description: 'Force the reboot of a node even if the load is high'

- job:
      <<: *job_common_node
      name: 'Farm-ShutdownNode'
      parameters:
          - string:
                name: NODE_IP
                default: ''
                description: 'IP of the node to shutdown'
          - string:
                name: NODE_NAME
                default: ''
                description: '(optional) Node name, for debug purpose'
          - bool:
                name: FORCE
                default: false
                description: 'Force the shutdown of a node even if the load is high'

- job:
      name: 'Farm-DockerCleanup'
      node: master
      concurrent: false
      wrappers:
          - timestamps
          - ansicolor
          - timeout:
                timeout: 120
                fail: true
                type: no-activity
      triggers:
          - timed: '0,20,40 * * * *'
      parameters:
          - string:
                name: NODE_IP
                default: ''
                description: 'IP of the node to reboot (default to all nodes)'
      properties:
          - build-discarder:
                days-to-keep: 7
          - inject:
                properties-content: |
                    SSH_USER=CARMD-EV-LXCIM_sa
                    DOCKER_ENCAPS_SHELL=/bin/bash
                    DOCKER_ENCAPS_IMG=registry.legato/os-farm-toolbox-18.04
                    DOCKER_ENCAPS_NET=--hostname=jenkins
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-jenkins-creds
          - shell: !include-raw: farm-commonenv.sh
          - inject:
                properties-file: build_env
          - description-setter:
                regexp: '^Scope: (.*)'
          - shell: !include-raw: farm-common.sh
          - system-groovy:
                command: !include-raw: farm-dockercleanup.groovy
      publishers:
          - encaps-cleanup
          - cleanup-workspace
          - slack:
                notify-start: false
                notify-success: false
                notify-aborted: false
                notify-not-built: false
                notify-unstable: true
                notify-failure: true
                notify-back-to-normal: true
                notify-repeated-failure: true

- job:
      name: 'Farm-Artifacts-Analyze'
      node: master
      concurrent: false
      wrappers:
          - timestamps
          - ansicolor
          - timeout:
                timeout: 180
                fail: true
                type: no-activity
      triggers:
          - timed: |
                TZ=America/Vancouver
                0 2 * * 7
      parameters:
          - string:
                name: ARTIFACT_PATH
                description: 'Artifact path to analyze'
                default: '/storage/artifacts'
      builders:
          - cleanup-workspace
          - shell: !include-raw: farm-storageanalyzeenv.sh
          - inject:
                properties-file: build_env
          - shell: !include-raw: farm-storageanalyze.sh
          - shell: !include-raw: farm-collectstoragemetrics.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace

- job:
      name: 'Farm-Artifacts-Cleanup'
      node: master
      concurrent: false
      triggers:
          - timed: '0 */4 * * *'
      wrappers:
          - timestamps
          - ansicolor
          - timeout:
                timeout: 60
                fail: true
                type: no-activity
      properties:
          - build-discarder:
                days-to-keep: 7
          - inject:
                properties-content: |
                    SSH_USER=CARMD-EV-LXCIM_sa
                    GERRIT_USER=carmd-ev-lxcim_sa
                    DOCKER_ENCAPS_SHELL=/bin/bash
                    DOCKER_ENCAPS_IMG=registry.legato/os-farm-toolbox-18.04
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-jenkins-creds
          - enable-sudo
          - shell: !include-raw: farm-commonenv.sh
          - inject:
                properties-file: build_env
          - shell: !include-raw: farm-common.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace
          - slack:
                notify-start: false
                notify-success: false
                notify-aborted: false
                notify-not-built: false
                notify-unstable: true
                notify-failure: true
                notify-back-to-normal: true
                notify-repeated-failure: true

- job:
      name: 'Farm-YoctoSstateCleanup'
      node: production && node.priority.normal
      concurrent: false
      triggers:
          - timed: |
                TZ=America/Vancouver
                0 0 * * 6
      wrappers:
          - timestamps
          - ansicolor
          - timeout:
                timeout: 240
                fail: true
                type: no-activity
      properties:
          - build-discarder:
                days-to-keep: 7
          - inject:
                properties-content: |
                    DOCKER_ENCAPS_SHELL=/bin/bash
                    DOCKER_ENCAPS_IMG=registry.legato/os-farm-toolbox-18.04
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-jenkins-creds
          - shell: !include-raw: farm-commonenv.sh
          - inject:
                properties-file: build_env
          - shell: !include-raw: farm-common.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace
          - trigger:
                project: Farm-YoctoSstateMirror
                threshold: UNSTABLE
          - slack:
                notify-start: false
                notify-success: false
                notify-aborted: false
                notify-not-built: false
                notify-unstable: true
                notify-failure: true
                notify-back-to-normal: true
                notify-repeated-failure: true

# Mirror sstate to Azure
- job:
      name: 'Farm-YoctoSstateMirror'
      node: master
      concurrent: false
      wrappers:
          - timestamps
          - ansicolor
          - timeout:
                timeout: 240
                fail: true
                type: no-activity
          - credentials-binding:
                - text:
                      credential-id: azure-jenkinsapp-terraformstorage
                      variable: ARM_ACCESS_KEY
      triggers:
          - timed: |
                TZ=America/Vancouver
                0 2 * * 0
      parameters:
          - string:
                name: YOCTO_VERSIONS
                description: 'Comma-separated list of sstate to sync (yocto-2.5,yocto-2.7 ...). Default to all.'
                default: ''
      properties:
          - build-discarder:
                days-to-keep: 14
          - inject:
                properties-content: |
                    DOCKER_ENCAPS_SHELL=/bin/bash
                    DOCKER_ENCAPS_IMG=registry.legato/os-farm-toolbox-18.04
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-jenkins-creds
          - shell: !include-raw: farm-commonenv.sh
          - inject:
                properties-file: build_env
          - shell: !include-raw: farm-common.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace

- job:
      name: 'Farm-Benchmark'
      project-type: pipeline
      parameters:
          - string:
                name: NODE
                description: '(optional) Name of the node to run the test on'
      dsl: !include-raw: farm-benchmark.groovy

- job_dns: &job_dns
      name: 'job_dns'
      concurrent: false
      node: production && node.priority.normal
      properties:
          - build-discarder:
                days-to-keep: 60
          - inject:
                properties-content: |
                    CHECKOUT_PROJECT=legato-jenkins
                    CHECKOUT_REBASE=1
                    DOCKER_ENCAPS_IMG=registry.legato/os-farm-toolbox-18.04
                    DOCKER_ENCAPS_SHELL=/bin/bash
                    DOCKER_ENCAPS_ARGS=--volume=$WORKSPACE:/ws \
                                       --volume=$WORKSPACE/passwd:/etc/passwd \
                                       --volume=$WORKSPACE/group:/etc/group \
                                       --volume=$WORKSPACE/.ssh:$HOME/.ssh \
                                       --volumes-from=legato-jenkins \
                                       -e WORKSPACE=/ws \
                                       -e LEGATO_SCRIPT_PATH=/legato-jenkins \
                                       -e BUILD_NUMBER=$BUILD_NUMBER \
                                       -e JOB_NAME=$JOB_NAME
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-jenkins-creds
          - checkout-project
          - shell: !include-raw: farm-updatedns.sh
          - description-setter:
                regexp: '^Serial Number: (.*)'

- job:
      name: 'Farm-DNS-Merged'
      triggers:
          - gerrit:
                trigger-on:
                    - change-merged-event
                projects:
                    - project-compare-type: 'PLAIN'
                      project-pattern: 'legato-jenkins'
                      branches:
                          - branch-compare-type: 'PLAIN'
                            branch-pattern: 'master'
                      file-paths:
                          - compare-type: 'ANT'
                            pattern: 'docker/services/bind/**'
                server-name: 'gerrit-legato'
      publishers:
          - encaps-cleanup
          - cleanup-workspace
          - slack:
                notify-start: false
                notify-success: false
                notify-aborted: false
                notify-not-built: false
                notify-unstable: true
                notify-failure: true
                notify-back-to-normal: true
                notify-repeated-failure: true
      <<: *job_dns

- job:
      name: 'Farm-DNS-Review'
      triggers:
          - gerrit:
                trigger-on:
                    - patchset-created-event
                projects:
                    - project-compare-type: 'PLAIN'
                      project-pattern: 'legato-jenkins'
                      branches:
                          - branch-compare-type: 'PLAIN'
                            branch-pattern: 'master'
                      file-paths:
                          - compare-type: 'ANT'
                            pattern: 'docker/services/bind/**'
                server-name: 'gerrit-legato'
      publishers:
          - encaps-cleanup
          - cleanup-workspace
      <<: *job_dns

- job:
      name: 'Farm-UpdateMonitoring'
      concurrent: false
      node: production && node.priority.normal
      parameters:
          - bool:
                name: UPDATE_SERVICE
                default: false
          - bool:
                name: UPDATE_CLIENTS
                default: false
      triggers:
          - gerrit:
                trigger-on:
                    - change-merged-event
                projects:
                    - project-compare-type: 'PLAIN'
                      project-pattern: 'legato-jenkins'
                      branches:
                          - branch-compare-type: 'PLAIN'
                            branch-pattern: 'master'
                      file-paths:
                          - compare-type: 'ANT'
                            pattern: 'docker/services/monitor/**'
                          - compare-type: 'ANT'
                            pattern: 'docker/services/sensu/**'
                server-name: 'gerrit-legato'
      properties:
          - build-discarder:
                days-to-keep: 60
          - inject:
                properties-content: |
                    CHECKOUT_PROJECT=legato-jenkins
                    DOCKER_ENCAPS_IMG=registry.legato/os-farm-toolbox-18.04
                    DOCKER_ENCAPS_SHELL=/bin/bash
                    DOCKER_ENCAPS_ARGS=--volume=$WORKSPACE:/ws \
                                       --volume=$WORKSPACE/passwd:/etc/passwd \
                                       --volume=$WORKSPACE/group:/etc/group \
                                       --volume=$WORKSPACE/.ssh:$HOME/.ssh \
                                       --volume=/etc/ssl/certs:/etc/ssl/certs:ro \
                                       --volumes-from=legato-jenkins \
                                       -e WORKSPACE=/ws \
                                       -e LEGATO_SCRIPT_PATH=/legato-jenkins \
                                       -e BUILD_NUMBER=$BUILD_NUMBER \
                                       -e UPDATE_SERVICE=$UPDATE_SERVICE \
                                       -e UPDATE_CLIENTS=$UPDATE_CLIENTS
      builders:
          - cleanup-workspace
          - checkout-project
          - provide-local-user
          - provide-jenkins-creds
          - shell: !include-raw: farm-updatemonitoring.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace
          - slack:
                notify-start: false
                notify-success: false
                notify-aborted: false
                notify-not-built: false
                notify-unstable: true
                notify-failure: true
                notify-back-to-normal: true
                notify-repeated-failure: true

- job:
      name: 'Farm-AnalyzeAzureResources'
      node: production && (master || node.priority.normal)
      triggers:
          - timed: '@daily'
      wrappers:
          - timestamps
          - ansicolor
          - timeout:
                timeout: 60
                fail: true
                type: no-activity
          - credentials-binding:
                - username-password-separated:
                      credential-id: azure-jenkinsapp-SA
                      username: ARM_CLIENT_ID
                      password: ARM_CLIENT_SECRET
      properties:
          - build-discarder:
                days-to-keep: 7
          - inject:
                properties-content: |
                    DOCKER_ENCAPS_SHELL=/bin/bash
                    DOCKER_ENCAPS_IMG=registry.legato/os-farm-toolbox-18.04
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-jenkins-creds
          - enable-sudo
          - shell: !include-raw: farm-commonenv.sh
          - inject:
                properties-file: build_env
          - shell: !include-raw: farm-common.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace
          - slack:
                notify-start: false
                notify-success: false
                notify-aborted: false
                notify-not-built: false
                notify-unstable: true
                notify-failure: true
                notify-back-to-normal: true
                notify-repeated-failure: true

- job:
      name: 'Farm-CreateAzureDiskSnapshots'
      node: production && node.priority.normal
      concurrent: false
      wrappers:
          - timestamps
          - ansicolor
          - credentials-binding:
                - username-password-separated:
                      credential-id: azure-jenkinsapp-SA
                      username: ARM_CLIENT_ID
                      password: ARM_CLIENT_SECRET
                - text:
                      credential-id: azure-jenkinsapp-terraformstorage
                      variable: ARM_ACCESS_KEY
      parameters:
          - string:
                name: SERVER_NAME
                description: 'Name of specify Azure server for manual snapshot. Ex: AZUSW2-CTO-CVM-klocwk'
          - string:
                name: RESOURCE_GROUP
                description: 'Enter the Azure resource group that server is in. Ex: AZUSW2-CTO-CRG-Servers'
          - string:
                name: NUM_SNAPSHOT_KEEP
                default: '2'
                description: 'Number of snapshot disks need to be kept for each disk'
      triggers:
          - timed: '0 0 * * 7'
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-jenkins-creds
          - enable-sudo
          - shell: !include-raw: farm-createazuredisksnapshotsenv.sh
          - inject:
                properties-file: build_env
          - shell: !include-raw: farm-createazuredisksnapshots.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace
          - slack:
                notify-start: false
                notify-success: false
                notify-aborted: false
                notify-not-built: false
                notify-unstable: true
                notify-failure: true
                notify-back-to-normal: true
                notify-repeated-failure: true

- job:
      name: 'Farm-MigrateDockerRegistry'
      node: power
      concurrent: false
      wrappers:
          - timestamps
          - ansicolor
          - credentials-binding:
                - username-password-separated:
                      credential-id: azure-cr-swifarm
                      username: ACR_USERNAME
                      password: ACR_PASSWORD
      parameters:
          - string:
                name: ACR_REGISTRY_NAME
                description: 'Name of ACR registry name. EX: swifarmacr'
          - bool:
                name: DRY_RUN
                default: true
      builders:
          - cleanup-workspace
          - shell: !include-raw: farm-migratedockerregistry.sh
      publishers:
          - cleanup-workspace

- job:
      name: 'Farm-BackupDB'
      node: production && node.priority.normal
      concurrent: false
      wrappers:
          - timestamps
          - ansicolor
          - credentials-binding:
                - username-password-separated:
                      credential-id: master-mongodb-readonly
                      username: MG_DB_USERNAME
                      password: MG_DB_PASSWORD
                - username-password-separated:
                      credential-id: gerrit-master-postgres-readonly
                      username: PG_USERNAME
                      password: PG_PASSWORD
                - text:
                      credential-id: azure-jenkinsapp-terraformstorage
                      variable: ARM_ACCESS_KEY
      parameters:
          - string:
                name: NUM_DUMP_KEEP
                default: '2'
                description: 'Number of dump version need to be kept'
          - string:
                name: DB_TYPE
                description: 'Type of database. Ex: mongo, postgres'
          - string:
                name: DB_NAME
                description: 'Database name'
          - string:
                name: SERVER_NAME
                description: 'Name of server'
          - string:
                name: SERVER_IP
                description: 'IP/FQDN of server'
      properties:
          - build-discarder:
                days-to-keep: 60
      triggers:
          - timed: '0 0 * * 7'
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-jenkins-creds
          - shell: !include-raw: farm-backupdbenv.sh
          - enable-sudo
          - inject:
                properties-file: build_env
          - shell: !include-raw: farm-backupdb.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace
          - slack:
                notify-start: false
                notify-success: false
                notify-aborted: false
                notify-not-built: false
                notify-unstable: true
                notify-failure: true
                notify-back-to-normal: true
                notify-repeated-failure: true

- job:
      name: 'Farm-BackupTags'
      node: power
      wrappers:
          - timestamps
          - ansicolor
          - credentials-binding:
                - text:
                      credential-id: azure-backup-storage
                      variable: ACCESS_KEY
      parameters:
          - string:
                name: PROJECT
                description: 'Project'
          - string:
                name: TAG_NAME
                description: 'Tag name'
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-build-user
          - provide-jenkins-creds
          - shell: !include-raw: farm-backupartifactsenv.sh
          - inject:
                properties-file: build_env
          - shell: !include-raw: farm-backupartifacts.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace
          - slack:
                notify-start: false
                notify-success: false
                notify-aborted: false
                notify-not-built: false
                notify-unstable: true
                notify-failure: true
                notify-back-to-normal: true
                notify-repeated-failure: true

- job:
      name: 'Farm-Scale-SpecialNodes'
      node: master
      concurrent: false
      wrappers:
          - timestamps
          - ansicolor
          - timeout:
                timeout: 60
                fail: true
                type: no-activity
          - credentials-binding:
                - username-password-separated:
                      credential-id: azure-jenkinsapp-SA
                      username: ARM_CLIENT_ID
                      password: ARM_CLIENT_SECRET
                - text:
                      credential-id: azure-jenkinsapp-terraformstorage
                      variable: ARM_ACCESS_KEY
      parameters:
          - string:
                name: TARGET_NB_NODES
                description: 'Number of nodes to instanciate'
          - string:
                name: LABELS
                description: "Node's labels"
          - choice:
                name: NODE_PRIOTITY
                choices:
                    - spot
                    - normal
                default: 'spot'
                description: 'Priority of nodes'
          - string:
                name: OWNER
                description: 'Team will use these nodes'
          - bool:
                name: DESTROY
                default: false
                description: 'True to destroy nodes'
      properties:
          - build-discarder:
                days-to-keep: 7
          - inject:
                properties-content: |
                    SSH_USER=CARMD-EV-LXCIM_sa
                    DOCKER_ENCAPS_SHELL=/bin/bash
                    DOCKER_ENCAPS_IMG=registry.legato/os-farm-toolbox-18.04
                    DOCKER_ENCAPS_NET=--hostname=jenkins
                    CHECKOUT_PROJECT=swi-farm
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-jenkins-creds
          - checkout-project
          - enable-sudo
          - shell: !include-raw: farm-commonenv.sh
          - inject:
                properties-file: build_env
          - shell: !include-raw: farm-common.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace
          - slack:
                notify-start: false
                notify-success: false
                notify-aborted: false
                notify-not-built: false
                notify-unstable: false
                notify-failure: true
                notify-back-to-normal: true
                notify-repeated-failure: true

- job:
      name: 'Farm-MonitorProAct'
      properties:
          - build-discarder:
                days-to-keep: 15
      wrappers:
          - timestamps
          - ansicolor
          - credentials-binding:
                - username-password-separated:
                      credential-id: swi-SA
                      username: SA_USERNAME
                      password: SA_PASSWORD
      triggers:
          - generic-webhook-trigger:
                token: sensu
                cause: 'Triggered by sensu event: https://monitor.legato/uchiwa/#/client/Farm/${CLIENT_NAME}?check=${CHECK_NAME}'
                print-post-content: true
                print-contrib-var: true
                regex-filter-text: $CHECK_STATUS $CLIENT_NAME,
                regex-filter-expression: ^2 (.*prod-jenkins|AZUSW2-CTO-CVM-prod-master|AZUSW2-CTO-CVM-gerrit-internal-master|.*-git01)
                post-content-params:
                    - type: JSONPath
                      key: CLIENT_NAME
                      value: $.client.name
                    - type: JSONPath
                      key: CLIENT_SUBSCRIPTIONS
                      value: $.client.subscriptions
                    - type: JSONPath
                      key: CLIENT_IP
                      value: $.client.address
                    - type: JSONPath
                      key: CHECK_NAME
                      value: $.check.name
                    - type: JSONPath
                      key: CHECK_OUTPUT
                      value: $.check.output
                    - type: JSONPath
                      key: CHECK_STATUS
                      value: $.check.status
                    - type: JSONPath
                      key: CHECK_INTERVAL
                      value: $.check.interval
                    - type: JSONPath
                      key: TIMESTAMP
                      value: $.timestamp
                    - type: JSONPath
                      key: CHECK_LAST_OK
                      value: $.last_ok
                    - type: JSONPath
                      key: CHECK_OCCURRENCES
                      value: $.occurrences
      parameters:
          - string:
                name: CLIENT_NAME
          - string:
                name: CLIENT_SUBSCRIPTIONS
          - string:
                name: CLIENT_IP
          - string:
                name: CHECK_NAME
          - string:
                name: CHECK_OUTPUT
          - string:
                name: CHECK_STATUS
          - string:
                name: CHECK_INTERVAL
          - string:
                name: TIMESTAMP
          - string:
                name: CHECK_LAST_OK
          - string:
                name: CHECK_OCCURRENCES
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-jenkins-creds
          - provide-utils-email
          - shell: !include-raw: farm-monitorproactenv.sh
          - inject:
                properties-file: build_env
          - shell: !include-raw: farm-monitorproact.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace

- job:
      name: 'Farm-Artifacts-Archive'
      node: master
      concurrent: false
      wrappers:
          - timestamps
          - ansicolor
          - credentials-binding:
                - text:
                      credential-id: azure-backup-storage
                      variable: ACCESS_KEY
      parameters:
          - bool:
                name: DRY_RUN
                default: true
                description: 'Dry run'
          - string:
                name: PROJECT
                description: 'Project'
          - string:
                name: TAG_NAMES
                description: 'List of tag name. Separate by ",".'
          - choice:
                name: ARCHIVE_TYPE
                choices:
                    - Archive
                    - Delete
                default: 'Archive'
                description: 'Delete: delete both on get.legato and backup storage.
                    Archive: delete on get.legato and skip on backup storage'
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-jenkins-creds
          - enable-sudo
          - shell: !include-raw: farm-archiveartifactsenv.sh
          - inject:
                properties-file: build_env
          - shell: !include-raw: farm-archiveartifacts.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace
- job:
      name: 'Farm-RestoreTag'
      node: master
      concurrent: false
      wrappers:
          - timestamps
          - ansicolor
          - credentials-binding:
                - text:
                      credential-id: azure-backup-storage
                      variable: ACCESS_KEY
      parameters:
          - string:
                name: PROJECT
                description: 'Project'
          - string:
                name: TAG_NAME
                description: 'TagName'
      builders:
          - cleanup-workspace
          - provide-local-user
          - provide-jenkins-creds
          - enable-sudo
          - shell: !include-raw: farm-restoretagsenv.sh
          - inject:
                properties-file: build_env
          - shell: !include-raw: farm-restoretags.sh
      publishers:
          - encaps-cleanup
          - cleanup-workspace

- publisher:
      name: save-gerrit-stats-artifacts
      publishers:
          - postbuildscript:
                mark-unstable-if-failed: true
                builders:
                    - role: BOTH # default
                      build-on:
                          - SUCCESS
                      build-steps:
                          - shell: !include-raw: gerrit-stats-saveartifacts.sh

- job:
      name: 'Gerrit-Stats'
      node: master
      description: 'Generate Gerrit Stats Automatically By Jenkins Jobs'
      parameters:
          - choice:
                name: TYPE_OF_UPDATE
                choices:
                    - data
                    - ui
                default: 'data'
                description: 'Type of update'
          - bool:
                name: SKIP_DOWNLOAD_STEP
                value: false
                description: 'Skip download step'
          - string:
                name: ARTIFACT_PATH
                description: 'Where to collect artifacts'
                default: '/storage/artifacts/farm/gerrit-stats/VERSION'
      properties:
          - build-discarder:
                days-to-keep: 15
      triggers:
          - timed: '0 0 * * 0'
      builders:
          - shell: !include-raw: gerrit-stats.sh
      publishers:
          - save-gerrit-stats-artifacts
